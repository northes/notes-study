  ## é¡¹ç›®ç±»å‹

æ–°å»ºé¡¹ç›®ç±»å‹ï¼šPipeline

## é…ç½®

1. å‹¾é€‰ï¼šä¸å…è®¸å¹¶è¡Œæ„å»º
2. å‹¾é€‰ï¼šå…è®¸æ‰“æ–­ä¸Šä¸€ä¸ªæ„å»º
3. å‹¾é€‰ï¼šå‚æ•°åŒ–æ„å»ºè¿‡ç¨‹

## å‡­è¯

1. ç”¨äºæ‹‰å–ç§æœ‰ä»“åº“çš„ SSH ç§é’¥
2. ç”¨äºæ¨é€ä¸æ‹‰å–ç¼“å­˜çš„ Kaniko é…ç½®

Kaniko é…ç½®å‚è€ƒ

```bash
echo -n USER:PASSWORD | base64
```

```json
{
    "auths": {
        "registry.cn-shenzhen.aliyuncs.com": {
            "auth": "<Base64:(username:password)>"
        },
        "registry.cn-hongkong.aliyuncs.com": {
            "auth": "<Base64:(username:password)>"
        }
    }
}
```

## å‚æ•°

1. å‹¾é€‰ï¼šå‚æ•°åŒ–é…ç½®è¿‡ç¨‹

å‚æ•°åˆ—è¡¨

| å‚æ•°å           | ç±»å‹ | é»˜è®¤å€¼       | å¿…å¡« | å«ä¹‰     |
| ---------------- | ---- | ------------ | ---- | -------- |
| GAME_BRANCH      | é€‰é¡¹ | 1.0          | y    | åˆ†æ”¯     |
| GAME_PLATFORM    | é€‰é¡¹ | wx_mini      | y    | å¹³å°     |
| GAME_MODE        | é€‰é¡¹ | dev          | y    | æ¨¡å¼     |
| GAME_SERVER_TYPE | é€‰é¡¹ | game         | y    | æœåŠ¡     |
| DABAI_ATTER      | å­—ç¬¦ | ä¸´æ—¶é…è¡¨æ›´æ–° | y    | å¤§ç™½é€šçŸ¥ |


> è¿™é‡Œçš„ç±»å‹ä»…ä¸ºäº†åœ¨åå°æ‰‹åŠ¨å¯åŠ¨ Job æ—¶æ–¹ä¾¿ä½¿ç”¨ï¼Œé€šè¿‡ API è¿›è¡Œè°ƒç”¨æ—¶ä¸å—å½±å“

## Pipeline

```Groovy
pipeline{
    agent none
    stages{
        stage('Prepare and Build') {
            agent {
                docker {
                    image 'szyhf/golang-alpine:latest'
                    label 'agent-1'
                }
            }
            environment {
                SSH_PRIVATE_KEY = credentials('ssh-privide-key')
                SKIP_UPDATE_TOOLS = 'true'

                // å¦‚è¦ä¿®æ”¹ç¼“å­˜è·¯å¾„ï¼Œéœ€åŒæ—¶ä¿®æ”¹æ‰€æœ‰é˜¶æ®µçš„ GOPATH
                GOPATH = "${WORKSPACE}/.go"
                GOMODCACHE = "${WORKSPACE}/.go/pkg/mod"
                GOCACHE = "${WORKSPACE}/.go/.cache/go-build"
                GOLANGCI_LINT_CACHE = "${WORKSPACE}/.go/.cache/golangci-lint"
                GOPROXY = 'https://goproxy.cn,direct'
                GOPRIVATE = 'gitlab.shouyouqianxian.com'
            }
            steps {
                echo WORKSPACE
                // ä½¿ç”¨å‡­è¯æ‹‰å–ç§æœ‰ä»“åº“
                sshagent (credentials: ["ssh-privide-key"]) {
                    sh """
                        mkdir -p /root/.ssh
                        chmod 700 /root/.ssh
                        ssh-keyscan gitlab.shouyouqianxian.com > /root/.ssh/known_hosts;
                        ssh -T git@gitlab.shouyouqianxian.com;
                        go env;
                        go install gitlab.shouyouqianxian.com/bingo/bing@master;

                        # ä¸‹è½½game_server_proto
                        rm -rf $GOPATH/src/gitlab.shouyouqianxian.com/xia/game_server_proto;
                        mkdir -p $GOPATH/src/gitlab.shouyouqianxian.com/xia/game_server_proto;
                        git archive --remote git@gitlab.shouyouqianxian.com:xia/game_server_proto.git master | tar -x -C $GOPATH/src/gitlab.shouyouqianxian.com/xia/game_server_proto;

                        # ä¸‹è½½game_server
                        rm -rf $GOPATH/src/gitlab.shouyouqianxian.com/xia/game_server;
                        git clone --depth=1 -b ${params.GAME_BRANCH} git@gitlab.shouyouqianxian.com:xia/game_server.git $GOPATH/src/gitlab.shouyouqianxian.com/xia/game_server;
                        cd $GOPATH/src/gitlab.shouyouqianxian.com/xia/game_server ;
                        go work init ;
                        go work use $GOPATH/src/gitlab.shouyouqianxian.com/xia/game_server $GOPATH/src/gitlab.shouyouqianxian.com/xia/game_server_proto ;
                        chmod +x ./update.sh ;
                        ./update.sh -gd=${params.GAME_PLATFORM}

                        # æ„å»ºå¹¶ç”Ÿæˆ kaniko è„šæœ¬
                        cd $GOPATH/src/gitlab.shouyouqianxian.com/xia/game_server ;
                        chmod +x ./docker/push/auto.sh ;
                        ./docker/push/auto.sh ${params.GAME_PLATFORM},${params.GAME_MODE},${params.GAME_SERVER_TYPE} dabai=${params.DABAI_ATTER} kaniko;
                    """                   
                }
            }
        }
        stage('Push') {
            agent {
                docker {
                    image 'gcr.io/kaniko-project/executor:debug'
                    args "--entrypoint=''" // Jenkins ä¼šå…ˆå¯åŠ¨å®¹å™¨ï¼Œå¹¶ä½¿ç”¨ cat å‘½ä»¤ hold ä½ï¼Œéœ€ä½¿ç”¨ debug çš„ Tag çš„é•œåƒï¼Œå¹¶ä¿®æ”¹ entrypoint
                    label "agent-1"
                }
            }
            environment {
                CI_PROJECT_DIR = "${GOPATH}/src/gitlab.shouyouqianxian.com/xia/game_server"
                CI_COMMIT_BRANCH = "${GAME_BRANCH}"
                KANIKO_AUTH_FILE = credentials('kanico-auth-config')
                GOPATH = "${WORKSPACE}/.go"
            }
            steps {
                sh """
                    cat $KANIKO_AUTH_FILE > /kaniko/.docker/config.json ; # auth ä¸éœ€è¦ https å¼€å¤´
                    cd $GOPATH/src/gitlab.shouyouqianxian.com/xia/game_server ;
                    chmod +x ./kaniko.sh ;
                    ./kaniko.sh 
                """
            }
        }
    }
    post {
        success {
            echo 'æ„å»ºæˆåŠŸï¼ğŸ‰ğŸ‰'
        }
        failure {
            echo 'æ„å»ºå¤±è´¥ï¼Œè¯·æ£€æŸ¥ï¼ğŸ™ˆ'
        }
    }
}
```