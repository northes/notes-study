
## 新开服

### 配置文件

#### cluster.yaml

1. Register.Game.Name
2. Register.Game.AdminAdvertiseAddr
3. Namespace，注意有没有改动，有则修改
4. Services.Game.LeaderName

#### db.yaml

1. 修改 Mysql 与 Redis 地址、用户名、密码

#### bingo.yaml

1. Discover.Redis ，注意修改地址与密码等

#### app.yaml

1. login，game 服的
2. Secrets\[&AuthLoginKey\] 注意 login，game 的需要保持一致，其他的也要保持一致。否则会出现登录成功拿不到玩家数据的情况

### 后台

#### app.conf

1. 统一认证密钥 tokenKey 需要重新生成一个新的（32 位），不同的后台应区别开来

### 域名

查看解析是否正确

```shell
dig wx.mini.dev.game.2.jianxia.top
```


### docker-compose

#### 修改labels

1. 修改 dns，如果只是新开 2 服则与 1 服保持一致即可
2. 修改 labels 中的 services 名
	![[小小勇者/assets/Pasted image 20221207121503.png]]
3. 需改 labels 中的 vpc 名
	![[小小勇者/assets/Pasted image 20221207121550.png]]
4. 按需修改域名
	![](assets/Pasted%20image%2020230103150953.png)



#### 例子 🌰

```yaml
version: "3.6"  
services:  
  game:  
    image: 'registry.cn-shenzhen.aliyuncs.com/lfeng/little_hero_game_server:andr_cn-dev'  
    #restart: unless-stopped  
    dns:  
      # CN青岛内网的自建DNS服务器（目前在CNGM服）  
      - "192.168.0.135"  
      # CN青岛默认，避免由于自建网络异常导致无法访问数据库  
      - "100.100.2.136"  
      - "100.100.2.138"  
    networks:  
      - web  
      - default  
    labels:  
      - "com.centurylinklabs.watchtower.enable=true"  
  
      - "traefik.enable=true"  
      - "traefik.docker.network=web"  
  
      - "traefik.http.services.hero_game_andr_cn_dev.loadbalancer.server.port=8080"  
      - "traefik.http.routers.hero_game_andr_cn_dev.service=hero_game_andr_cn_dev"  
      - "traefik.http.routers.hero_game_andr_cn_dev.rule=Host(`littlehero.andr.cn.dev.game.l-feng.com`)"  
      - "traefik.http.routers.hero_game_andr_cn_dev.entrypoints=websecure"  
      - "traefik.http.routers.hero_game_andr_cn_dev.tls.certResolver=myhttpchallenge"  
      - "traefik.http.routers.hero_game_andr_cn_dev.middlewares=gzip"  
  
      - "traefik.http.routers.hero_game_andr_cn_dev-http.service=hero_game_andr_cn_dev"  
      - "traefik.http.routers.hero_game_andr_cn_dev-http.rule=Host(`littlehero.andr.cn.dev.game.l-feng.com`)"  
      - "traefik.http.routers.hero_game_andr_cn_dev-http.entrypoints=web"  
      - "traefik.http.routers.hero_game_andr_cn_dev-http.middlewares=https-only,gzip"  
  
      - "traefik.http.services.hero_game_andr_cn_vpc_dev.loadbalancer.server.port=18080"  
      - "traefik.http.services.hero_game_andr_cn_vpc_dev.loadbalancer.server.scheme=h2c"  
      - "traefik.http.routers.hero_game_andr_cn_vpc_dev.service=hero_game_andr_cn_vpc_dev"  
      - "traefik.http.routers.hero_game_andr_cn_vpc_dev.entrypoints=vpc"  
      - "traefik.http.routers.hero_game_andr_cn_vpc_dev.rule=Host(`littlehero-vpc.andr.cn.dev.game.local`)"  
    volumes:  
      - "$PWD/game/conf:/little_hero_game_server/conf"  
      - "$PWD/game/log:/little_hero_game_server/runtimes/log"  
      - "$PWD/game/trace:/little_hero_game_server/runtimes/trace"  
      - "$PWD/game/dump:/little_hero_game_server/runtimes/dump"  
  trace_compress:  
    image: 'registry.cn-shenzhen.aliyuncs.com/lfeng/trace_compress:latest'  
    restart: unless-stopped  
    command:  
      - -trace_dir=/game/trace  
      - -byte_per_second=2000000  
      - -s="0 30 */1 * *"  
      - -d=2  
    volumes:  
      - "$PWD/game/trace:/game/trace:rw"  
  game2:  
    image: 'registry.cn-shenzhen.aliyuncs.com/lfeng/little_hero_game_server:andr_cn-dev'  
    # restart: unless-stopped  
    dns:  
      # CN青岛内网的自建DNS服务器（目前在CNGM服）  
      - "192.168.0.135"  
      # CN青岛默认，避免由于自建网络异常导致无法访问数据库  
      - "100.100.2.136"  
      - "100.100.2.138"  
    networks:  
      - web  
      - default  
    labels:  
      - "com.centurylinklabs.watchtower.enable=true"  
      - "traefik.enable=true"  
      - "traefik.docker.network=web"  
  
      - "traefik.http.services.hero_game_2_andr_cn_dev.loadbalancer.server.port=8080"  
      - "traefik.http.routers.hero_game_2_andr_cn_dev.service=hero_game_2_andr_cn_dev"  
      - "traefik.http.routers.hero_game_2_andr_cn_dev.rule=Host(`littlehero.andr.cn.dev.game.2.l-feng.com`)"  
      - "traefik.http.routers.hero_game_2_andr_cn_dev.entrypoints=websecure"  
      - "traefik.http.routers.hero_game_2_andr_cn_dev.tls.certResolver=myhttpchallenge"  
      - "traefik.http.routers.hero_game_2_andr_cn_dev.middlewares=gzip"  
  
      - "traefik.http.routers.hero_game_2_andr_cn_dev-http.service=hero_game_2_andr_cn_dev"  
      - "traefik.http.routers.hero_game_2_andr_cn_dev-http.rule=Host(`littlehero.andr.cn.dev.game.2.l-feng.com`)"  
      - "traefik.http.routers.hero_game_2_andr_cn_dev-http.entrypoints=web"  
      - "traefik.http.routers.hero_game_2_andr_cn_dev-http.middlewares=https-only,gzip"  
  
      - "traefik.http.services.hero_game_andr_cn_vpc_dev_2.loadbalancer.server.port=18080"  
      - "traefik.http.services.hero_game_andr_cn_vpc_dev_2.loadbalancer.server.scheme=h2c"  
      - "traefik.http.routers.hero_game_andr_cn_vpc_dev_2.service=hero_game_andr_cn_vpc_dev_2"  
      - "traefik.http.routers.hero_game_andr_cn_vpc_dev_2.entrypoints=vpc"  
      - "traefik.http.routers.hero_game_andr_cn_vpc_dev_2.rule=Host(`littlehero-vpc.andr.cn.dev.game.2.local`)"  
    volumes:  
      - "$PWD/game2/conf:/little_hero_game_server/conf"  
      - "$PWD/game2/log:/little_hero_game_server/runtimes/log"  
      - "$PWD/game2/trace:/little_hero_game_server/runtimes/trace"  
      - "$PWD/game2/dump:/little_hero_game_server/runtimes/dump"  
  chat:  
    image: 'registry.cn-shenzhen.aliyuncs.com/lfeng/little_hero_chat_server:andr_cn-dev'  
    # restart: unless-stopped  
    dns:  
      # CN青岛内网的自建DNS服务器（目前在CNGM服）  
      - "192.168.0.135"  
      # CN青岛默认，避免由于自建网络异常导致无法访问数据库  
      - "100.100.2.136"  
      - "100.100.2.138"  
    volumes:  
      - "$PWD/chat/conf:/little_hero_chat_server/conf"  
      - "$PWD/chat/log:/little_hero_chat_server/runtimes/log"  
    networks:  
      - web  
      - default  
    labels:  
      - "com.centurylinklabs.watchtower.enable=true"  
  
      - "traefik.enable=true"  
      - "traefik.docker.network=web"  
  
      - "traefik.http.services.hero_chat_andr_cn_dev.loadbalancer.server.port=8080"  
      - "traefik.http.routers.hero_chat_andr_cn_dev.service=hero_chat_andr_cn_dev"  
      - "traefik.http.routers.hero_chat_andr_cn_dev.rule=Host(`littlehero.andr.cn.dev.chat.l-feng.com`)"  
      - "traefik.http.routers.hero_chat_andr_cn_dev.entrypoints=websecure"  
      - "traefik.http.routers.hero_chat_andr_cn_dev.tls.certResolver=myhttpchallenge"  
      - "traefik.http.routers.hero_chat_andr_cn_dev.middlewares=gzip"  
  
      - "traefik.http.routers.hero_chat_andr_cn_dev-http.service=hero_chat_andr_cn_dev"  
      - "traefik.http.routers.hero_chat_andr_cn_dev-http.rule=Host(`littlehero.andr.cn.dev.chat.l-feng.com`)"  
      - "traefik.http.routers.hero_chat_andr_cn_dev-http.entrypoints=web"  
      - "traefik.http.routers.hero_chat_andr_cn_dev-http.middlewares=https-only,gzip"  
  
      - "traefik.http.services.hero_chat_andr_cn_vpc_dev.loadbalancer.server.port=18080"  
      - "traefik.http.services.hero_chat_andr_cn_vpc_dev.loadbalancer.server.scheme=h2c"  
      - "traefik.http.routers.hero_chat_andr_cn_vpc_dev.service=hero_chat_andr_cn_vpc_dev"  
      - "traefik.http.routers.hero_chat_andr_cn_vpc_dev.entrypoints=vpc"  
      - "traefik.http.routers.hero_chat_andr_cn_vpc_dev.rule=Host(`littlehero-vpc.andr.cn.dev.chat.local`)"  
  login:  
    image: "registry.cn-shenzhen.aliyuncs.com/lfeng/little_hero_login_server:andr_cn-dev"  
#    restart: unless-stopped  
    dns:  
      # CN青岛内网的自建DNS服务器（目前在CNGM服）  
      - "192.168.0.135"  
      # CN青岛默认，避免由于自建网络异常导致无法访问数据库  
      - "100.100.2.136"  
      - "100.100.2.138"  
    networks:  
      - web  
      - default  
    labels:  
      - "com.centurylinklabs.watchtower.enable=true"  
  
      - "traefik.enable=true"  
      - "traefik.docker.network=web"  
  
      - "traefik.http.services.hero_login_andr_cn_dev.loadbalancer.server.port=8080"  
      - "traefik.http.routers.hero_login_andr_cn_dev.service=hero_login_andr_cn_dev"  
      - "traefik.http.routers.hero_login_andr_cn_dev.rule=Host(`littlehero.andr.cn.dev.login.l-feng.com`)"  
      - "traefik.http.routers.hero_login_andr_cn_dev.entrypoints=websecure"  
      - "traefik.http.routers.hero_login_andr_cn_dev.tls.certResolver=myhttpchallenge"  
      - "traefik.http.routers.hero_login_andr_cn_dev.middlewares=gzip"  
  
      - "traefik.http.routers.hero_login_andr_cn_dev-http.service=hero_login_andr_cn_dev"  
      - "traefik.http.routers.hero_login_andr_cn_dev-http.rule=Host(`littlehero.andr.cn.dev.login.l-feng.com`)"  
      - "traefik.http.routers.hero_login_andr_cn_dev-http.entrypoints=web"  
      - "traefik.http.routers.hero_login_andr_cn_dev-http.middlewares=https-only,gzip"  
  
      - "traefik.http.services.hero_login_andr_cn_vpc.loadbalancer.server.port=18080"  
      - "traefik.http.services.hero_login_andr_cn_vpc.loadbalancer.server.scheme=h2c"  
      - "traefik.http.routers.hero_login_andr_cn_vpc.service=hero_login_andr_cn_vpc"  
      - "traefik.http.routers.hero_login_andr_cn_vpc.entrypoints=vpc"  
      - "traefik.http.routers.hero_login_andr_cn_vpc.rule=Host(`littlehero-vpc.andr.cn.dev.login.local`)"  
    volumes:  
      - "$PWD/login/conf:/little_hero_login_server/conf"  
  rank:  
    image: 'registry.cn-shenzhen.aliyuncs.com/lfeng/little_hero_rank_server:andr_cn-dev'  
    # restart: unless-stopped  
    dns:  
      # CN青岛内网的自建DNS服务器（目前在CNGM服）  
      - "192.168.0.135"  
      # CN青岛默认，避免由于自建网络异常导致无法访问数据库  
      - "100.100.2.136"  
      - "100.100.2.138"  
    volumes:  
      - "$PWD/rank/conf:/little_hero_rank_server/conf"  
      - "$PWD/rank/log:/little_hero_rank_server/runtimes/log"  
    networks:  
      - web  
      - default  
    labels:  
      - "com.centurylinklabs.watchtower.enable=true"  
  
      - "traefik.enable=true"  
      - "traefik.docker.network=web"  
  
      - "traefik.http.services.hero_rank_andr_cn_vpc_dev.loadbalancer.server.port=18080"  
      - "traefik.http.services.hero_rank_andr_cn_vpc_dev.loadbalancer.server.scheme=h2c"  
      - "traefik.http.routers.hero_rank_andr_cn_vpc_dev.service=hero_rank_andr_cn_vpc_dev"  
      - "traefik.http.routers.hero_rank_andr_cn_vpc_dev.entrypoints=vpc"  
      - "traefik.http.routers.hero_rank_andr_cn_vpc_dev.rule=Host(`littlehero-vpc.andr.cn.dev.rank.local`)"  
  backend:  
    image: "registry.cn-shenzhen.aliyuncs.com/lfeng/little_hero_backend:andr_cn-dev"  
    restart: unless-stopped  
    dns:  
      # CN青岛内网的自建DNS服务器（目前在CNGM服）  
      - "192.168.0.135"  
      # CN青岛默认，避免由于自建网络异常导致无法访问数据库  
      - "100.100.2.136"  
      - "100.100.2.138"  
    networks:  
      - web  
      - default  
    labels:  
      - "com.centurylinklabs.watchtower.enable=true"  
  
      - "traefik.enable=true"  
      - "traefik.docker.network=web"  
  
      - "traefik.http.services.hero_cn_andr_backend_dev.loadbalancer.server.port=8080"  
      - "traefik.http.routers.hero_cn_andr_backend_dev.rule=Host(`littlehero.andr.cn.dev.console.l-feng.com`)"  
      - "traefik.http.routers.hero_cn_andr_backend_dev.entrypoints=websecure"  
      - "traefik.http.routers.hero_cn_andr_backend_dev.tls.certresolver=myhttpchallenge"  
  
      - "traefik.http.routers.hero_cn_andr_backend_dev_http.rule=Host(`littlehero.andr.cn.dev.console.l-feng.com`)"  
      - "traefik.http.routers.hero_cn_andr_backend_dev_http.entrypoints=web"  
      - "traefik.http.routers.hero_cn_andr_backend_dev_http.middlewares=https-only"  
    volumes:  
      - "$PWD/backend/conf:/little_hero_backend/conf"  
      - "$PWD/backend/runtimes:/little_hero_backend/runtimes"  
networks:  
  web:  
    external: true
```


## 修改服务

修改 `docker-compose.yaml` 的 labels 后，需要删除 container 并重新创建，restart 只是重启原来的 container，不会应用修改的变化

```shell
# 错误
docker-compose restart chat
# 正确
docker-compose up -d --build chat
# 正确
docker-compose stop chat
docker-compose rm chat
docker-compose create chat
docker-compose start chat
```


## 服务状态

### 验证

服务启动后，通过 **访问域名** 和 **查看日志** 验证服务是否正常启动

1. 查看服务输出日志
2. 尝试访问服务域名，200 即为正常
3. 验证 http 能否跳转 https

### 检查

服务未正常启动 或 无法访问 会报 404

1. 检查服务是否成功启动
2. 检查 docker-compose 中 service 和 rule 是否配置正确
3. 通过查看 traefik 日志辅助排查