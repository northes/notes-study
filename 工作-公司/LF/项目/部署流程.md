
## æ–°å¼€æœ

### é…ç½®æ–‡ä»¶

#### cluster.yaml

1. Register.Game.Name
2. Register.Game.AdminAdvertiseAddr
3. Namespaceï¼Œæ³¨æ„æœ‰æ²¡æœ‰æ”¹åŠ¨ï¼Œæœ‰åˆ™ä¿®æ”¹
4. Services.Game.LeaderName

#### db.yaml

1. ä¿®æ”¹ Mysql ä¸ Redis åœ°å€ã€ç”¨æˆ·åã€å¯†ç 

#### bingo.yaml

1. Discover.Redis ï¼Œæ³¨æ„ä¿®æ”¹åœ°å€ä¸å¯†ç ç­‰

#### app.yaml

1. loginï¼Œgame æœçš„
2. Secrets\[&AuthLoginKey\] æ³¨æ„ loginï¼Œgame çš„éœ€è¦ä¿æŒä¸€è‡´ï¼Œå…¶ä»–çš„ä¹Ÿè¦ä¿æŒä¸€è‡´ã€‚å¦åˆ™ä¼šå‡ºç°ç™»å½•æˆåŠŸæ‹¿ä¸åˆ°ç©å®¶æ•°æ®çš„æƒ…å†µ

### åå°

#### app.conf

1. ç»Ÿä¸€è®¤è¯å¯†é’¥ tokenKey éœ€è¦é‡æ–°ç”Ÿæˆä¸€ä¸ªæ–°çš„ï¼ˆ32 ä½ï¼‰ï¼Œä¸åŒçš„åå°åº”åŒºåˆ«å¼€æ¥

### åŸŸå

æŸ¥çœ‹è§£ææ˜¯å¦æ­£ç¡®

```shell
dig wx.mini.dev.game.2.jianxia.top
```


### docker-compose

#### ä¿®æ”¹labels

1. ä¿®æ”¹ dnsï¼Œå¦‚æœåªæ˜¯æ–°å¼€ 2 æœåˆ™ä¸ 1 æœä¿æŒä¸€è‡´å³å¯
2. ä¿®æ”¹ labels ä¸­çš„ services å
	![[å°å°å‹‡è€…/assets/Pasted image 20221207121503.png]]
3. éœ€æ”¹ labels ä¸­çš„ vpc å
	![[å°å°å‹‡è€…/assets/Pasted image 20221207121550.png]]
4. æŒ‰éœ€ä¿®æ”¹åŸŸå
	![](assets/Pasted%20image%2020230103150953.png)



#### ä¾‹å­ ğŸŒ°

```yaml
version: "3.6"  
services:  
  game:  
    image: 'registry.cn-shenzhen.aliyuncs.com/lfeng/little_hero_game_server:andr_cn-dev'  
    #restart: unless-stopped  
    dns:  
      # CNé’å²›å†…ç½‘çš„è‡ªå»ºDNSæœåŠ¡å™¨ï¼ˆç›®å‰åœ¨CNGMæœï¼‰  
      - "192.168.0.135"  
      # CNé’å²›é»˜è®¤ï¼Œé¿å…ç”±äºè‡ªå»ºç½‘ç»œå¼‚å¸¸å¯¼è‡´æ— æ³•è®¿é—®æ•°æ®åº“  
      - "100.100.2.136"  
      - "100.100.2.138"  
    networks:  
      - web  
      - default  
    labels:  
      - "com.centurylinklabs.watchtower.enable=true"  
  
      - "traefik.enable=true"  
      - "traefik.docker.network=web"  
  
      - "traefik.http.services.hero_game_andr_cn_dev.loadbalancer.server.port=8080"  
      - "traefik.http.routers.hero_game_andr_cn_dev.service=hero_game_andr_cn_dev"  
      - "traefik.http.routers.hero_game_andr_cn_dev.rule=Host(`littlehero.andr.cn.dev.game.l-feng.com`)"  
      - "traefik.http.routers.hero_game_andr_cn_dev.entrypoints=websecure"  
      - "traefik.http.routers.hero_game_andr_cn_dev.tls.certResolver=myhttpchallenge"  
      - "traefik.http.routers.hero_game_andr_cn_dev.middlewares=gzip"  
  
      - "traefik.http.routers.hero_game_andr_cn_dev-http.service=hero_game_andr_cn_dev"  
      - "traefik.http.routers.hero_game_andr_cn_dev-http.rule=Host(`littlehero.andr.cn.dev.game.l-feng.com`)"  
      - "traefik.http.routers.hero_game_andr_cn_dev-http.entrypoints=web"  
      - "traefik.http.routers.hero_game_andr_cn_dev-http.middlewares=https-only,gzip"  
  
      - "traefik.http.services.hero_game_andr_cn_vpc_dev.loadbalancer.server.port=18080"  
      - "traefik.http.services.hero_game_andr_cn_vpc_dev.loadbalancer.server.scheme=h2c"  
      - "traefik.http.routers.hero_game_andr_cn_vpc_dev.service=hero_game_andr_cn_vpc_dev"  
      - "traefik.http.routers.hero_game_andr_cn_vpc_dev.entrypoints=vpc"  
      - "traefik.http.routers.hero_game_andr_cn_vpc_dev.rule=Host(`littlehero-vpc.andr.cn.dev.game.local`)"  
    volumes:  
      - "$PWD/game/conf:/little_hero_game_server/conf"  
      - "$PWD/game/log:/little_hero_game_server/runtimes/log"  
      - "$PWD/game/trace:/little_hero_game_server/runtimes/trace"  
      - "$PWD/game/dump:/little_hero_game_server/runtimes/dump"  
  trace_compress:  
    image: 'registry.cn-shenzhen.aliyuncs.com/lfeng/trace_compress:latest'  
    restart: unless-stopped  
    command:  
      - -trace_dir=/game/trace  
      - -byte_per_second=2000000  
      - -s="0 30 */1 * *"  
      - -d=2  
    volumes:  
      - "$PWD/game/trace:/game/trace:rw"  
  game2:  
    image: 'registry.cn-shenzhen.aliyuncs.com/lfeng/little_hero_game_server:andr_cn-dev'  
    # restart: unless-stopped  
    dns:  
      # CNé’å²›å†…ç½‘çš„è‡ªå»ºDNSæœåŠ¡å™¨ï¼ˆç›®å‰åœ¨CNGMæœï¼‰  
      - "192.168.0.135"  
      # CNé’å²›é»˜è®¤ï¼Œé¿å…ç”±äºè‡ªå»ºç½‘ç»œå¼‚å¸¸å¯¼è‡´æ— æ³•è®¿é—®æ•°æ®åº“  
      - "100.100.2.136"  
      - "100.100.2.138"  
    networks:  
      - web  
      - default  
    labels:  
      - "com.centurylinklabs.watchtower.enable=true"  
      - "traefik.enable=true"  
      - "traefik.docker.network=web"  
  
      - "traefik.http.services.hero_game_2_andr_cn_dev.loadbalancer.server.port=8080"  
      - "traefik.http.routers.hero_game_2_andr_cn_dev.service=hero_game_2_andr_cn_dev"  
      - "traefik.http.routers.hero_game_2_andr_cn_dev.rule=Host(`littlehero.andr.cn.dev.game.2.l-feng.com`)"  
      - "traefik.http.routers.hero_game_2_andr_cn_dev.entrypoints=websecure"  
      - "traefik.http.routers.hero_game_2_andr_cn_dev.tls.certResolver=myhttpchallenge"  
      - "traefik.http.routers.hero_game_2_andr_cn_dev.middlewares=gzip"  
  
      - "traefik.http.routers.hero_game_2_andr_cn_dev-http.service=hero_game_2_andr_cn_dev"  
      - "traefik.http.routers.hero_game_2_andr_cn_dev-http.rule=Host(`littlehero.andr.cn.dev.game.2.l-feng.com`)"  
      - "traefik.http.routers.hero_game_2_andr_cn_dev-http.entrypoints=web"  
      - "traefik.http.routers.hero_game_2_andr_cn_dev-http.middlewares=https-only,gzip"  
  
      - "traefik.http.services.hero_game_andr_cn_vpc_dev_2.loadbalancer.server.port=18080"  
      - "traefik.http.services.hero_game_andr_cn_vpc_dev_2.loadbalancer.server.scheme=h2c"  
      - "traefik.http.routers.hero_game_andr_cn_vpc_dev_2.service=hero_game_andr_cn_vpc_dev_2"  
      - "traefik.http.routers.hero_game_andr_cn_vpc_dev_2.entrypoints=vpc"  
      - "traefik.http.routers.hero_game_andr_cn_vpc_dev_2.rule=Host(`littlehero-vpc.andr.cn.dev.game.2.local`)"  
    volumes:  
      - "$PWD/game2/conf:/little_hero_game_server/conf"  
      - "$PWD/game2/log:/little_hero_game_server/runtimes/log"  
      - "$PWD/game2/trace:/little_hero_game_server/runtimes/trace"  
      - "$PWD/game2/dump:/little_hero_game_server/runtimes/dump"  
  chat:  
    image: 'registry.cn-shenzhen.aliyuncs.com/lfeng/little_hero_chat_server:andr_cn-dev'  
    # restart: unless-stopped  
    dns:  
      # CNé’å²›å†…ç½‘çš„è‡ªå»ºDNSæœåŠ¡å™¨ï¼ˆç›®å‰åœ¨CNGMæœï¼‰  
      - "192.168.0.135"  
      # CNé’å²›é»˜è®¤ï¼Œé¿å…ç”±äºè‡ªå»ºç½‘ç»œå¼‚å¸¸å¯¼è‡´æ— æ³•è®¿é—®æ•°æ®åº“  
      - "100.100.2.136"  
      - "100.100.2.138"  
    volumes:  
      - "$PWD/chat/conf:/little_hero_chat_server/conf"  
      - "$PWD/chat/log:/little_hero_chat_server/runtimes/log"  
    networks:  
      - web  
      - default  
    labels:  
      - "com.centurylinklabs.watchtower.enable=true"  
  
      - "traefik.enable=true"  
      - "traefik.docker.network=web"  
  
      - "traefik.http.services.hero_chat_andr_cn_dev.loadbalancer.server.port=8080"  
      - "traefik.http.routers.hero_chat_andr_cn_dev.service=hero_chat_andr_cn_dev"  
      - "traefik.http.routers.hero_chat_andr_cn_dev.rule=Host(`littlehero.andr.cn.dev.chat.l-feng.com`)"  
      - "traefik.http.routers.hero_chat_andr_cn_dev.entrypoints=websecure"  
      - "traefik.http.routers.hero_chat_andr_cn_dev.tls.certResolver=myhttpchallenge"  
      - "traefik.http.routers.hero_chat_andr_cn_dev.middlewares=gzip"  
  
      - "traefik.http.routers.hero_chat_andr_cn_dev-http.service=hero_chat_andr_cn_dev"  
      - "traefik.http.routers.hero_chat_andr_cn_dev-http.rule=Host(`littlehero.andr.cn.dev.chat.l-feng.com`)"  
      - "traefik.http.routers.hero_chat_andr_cn_dev-http.entrypoints=web"  
      - "traefik.http.routers.hero_chat_andr_cn_dev-http.middlewares=https-only,gzip"  
  
      - "traefik.http.services.hero_chat_andr_cn_vpc_dev.loadbalancer.server.port=18080"  
      - "traefik.http.services.hero_chat_andr_cn_vpc_dev.loadbalancer.server.scheme=h2c"  
      - "traefik.http.routers.hero_chat_andr_cn_vpc_dev.service=hero_chat_andr_cn_vpc_dev"  
      - "traefik.http.routers.hero_chat_andr_cn_vpc_dev.entrypoints=vpc"  
      - "traefik.http.routers.hero_chat_andr_cn_vpc_dev.rule=Host(`littlehero-vpc.andr.cn.dev.chat.local`)"  
  login:  
    image: "registry.cn-shenzhen.aliyuncs.com/lfeng/little_hero_login_server:andr_cn-dev"  
#    restart: unless-stopped  
    dns:  
      # CNé’å²›å†…ç½‘çš„è‡ªå»ºDNSæœåŠ¡å™¨ï¼ˆç›®å‰åœ¨CNGMæœï¼‰  
      - "192.168.0.135"  
      # CNé’å²›é»˜è®¤ï¼Œé¿å…ç”±äºè‡ªå»ºç½‘ç»œå¼‚å¸¸å¯¼è‡´æ— æ³•è®¿é—®æ•°æ®åº“  
      - "100.100.2.136"  
      - "100.100.2.138"  
    networks:  
      - web  
      - default  
    labels:  
      - "com.centurylinklabs.watchtower.enable=true"  
  
      - "traefik.enable=true"  
      - "traefik.docker.network=web"  
  
      - "traefik.http.services.hero_login_andr_cn_dev.loadbalancer.server.port=8080"  
      - "traefik.http.routers.hero_login_andr_cn_dev.service=hero_login_andr_cn_dev"  
      - "traefik.http.routers.hero_login_andr_cn_dev.rule=Host(`littlehero.andr.cn.dev.login.l-feng.com`)"  
      - "traefik.http.routers.hero_login_andr_cn_dev.entrypoints=websecure"  
      - "traefik.http.routers.hero_login_andr_cn_dev.tls.certResolver=myhttpchallenge"  
      - "traefik.http.routers.hero_login_andr_cn_dev.middlewares=gzip"  
  
      - "traefik.http.routers.hero_login_andr_cn_dev-http.service=hero_login_andr_cn_dev"  
      - "traefik.http.routers.hero_login_andr_cn_dev-http.rule=Host(`littlehero.andr.cn.dev.login.l-feng.com`)"  
      - "traefik.http.routers.hero_login_andr_cn_dev-http.entrypoints=web"  
      - "traefik.http.routers.hero_login_andr_cn_dev-http.middlewares=https-only,gzip"  
  
      - "traefik.http.services.hero_login_andr_cn_vpc.loadbalancer.server.port=18080"  
      - "traefik.http.services.hero_login_andr_cn_vpc.loadbalancer.server.scheme=h2c"  
      - "traefik.http.routers.hero_login_andr_cn_vpc.service=hero_login_andr_cn_vpc"  
      - "traefik.http.routers.hero_login_andr_cn_vpc.entrypoints=vpc"  
      - "traefik.http.routers.hero_login_andr_cn_vpc.rule=Host(`littlehero-vpc.andr.cn.dev.login.local`)"  
    volumes:  
      - "$PWD/login/conf:/little_hero_login_server/conf"  
  rank:  
    image: 'registry.cn-shenzhen.aliyuncs.com/lfeng/little_hero_rank_server:andr_cn-dev'  
    # restart: unless-stopped  
    dns:  
      # CNé’å²›å†…ç½‘çš„è‡ªå»ºDNSæœåŠ¡å™¨ï¼ˆç›®å‰åœ¨CNGMæœï¼‰  
      - "192.168.0.135"  
      # CNé’å²›é»˜è®¤ï¼Œé¿å…ç”±äºè‡ªå»ºç½‘ç»œå¼‚å¸¸å¯¼è‡´æ— æ³•è®¿é—®æ•°æ®åº“  
      - "100.100.2.136"  
      - "100.100.2.138"  
    volumes:  
      - "$PWD/rank/conf:/little_hero_rank_server/conf"  
      - "$PWD/rank/log:/little_hero_rank_server/runtimes/log"  
    networks:  
      - web  
      - default  
    labels:  
      - "com.centurylinklabs.watchtower.enable=true"  
  
      - "traefik.enable=true"  
      - "traefik.docker.network=web"  
  
      - "traefik.http.services.hero_rank_andr_cn_vpc_dev.loadbalancer.server.port=18080"  
      - "traefik.http.services.hero_rank_andr_cn_vpc_dev.loadbalancer.server.scheme=h2c"  
      - "traefik.http.routers.hero_rank_andr_cn_vpc_dev.service=hero_rank_andr_cn_vpc_dev"  
      - "traefik.http.routers.hero_rank_andr_cn_vpc_dev.entrypoints=vpc"  
      - "traefik.http.routers.hero_rank_andr_cn_vpc_dev.rule=Host(`littlehero-vpc.andr.cn.dev.rank.local`)"  
  backend:  
    image: "registry.cn-shenzhen.aliyuncs.com/lfeng/little_hero_backend:andr_cn-dev"  
    restart: unless-stopped  
    dns:  
      # CNé’å²›å†…ç½‘çš„è‡ªå»ºDNSæœåŠ¡å™¨ï¼ˆç›®å‰åœ¨CNGMæœï¼‰  
      - "192.168.0.135"  
      # CNé’å²›é»˜è®¤ï¼Œé¿å…ç”±äºè‡ªå»ºç½‘ç»œå¼‚å¸¸å¯¼è‡´æ— æ³•è®¿é—®æ•°æ®åº“  
      - "100.100.2.136"  
      - "100.100.2.138"  
    networks:  
      - web  
      - default  
    labels:  
      - "com.centurylinklabs.watchtower.enable=true"  
  
      - "traefik.enable=true"  
      - "traefik.docker.network=web"  
  
      - "traefik.http.services.hero_cn_andr_backend_dev.loadbalancer.server.port=8080"  
      - "traefik.http.routers.hero_cn_andr_backend_dev.rule=Host(`littlehero.andr.cn.dev.console.l-feng.com`)"  
      - "traefik.http.routers.hero_cn_andr_backend_dev.entrypoints=websecure"  
      - "traefik.http.routers.hero_cn_andr_backend_dev.tls.certresolver=myhttpchallenge"  
  
      - "traefik.http.routers.hero_cn_andr_backend_dev_http.rule=Host(`littlehero.andr.cn.dev.console.l-feng.com`)"  
      - "traefik.http.routers.hero_cn_andr_backend_dev_http.entrypoints=web"  
      - "traefik.http.routers.hero_cn_andr_backend_dev_http.middlewares=https-only"  
    volumes:  
      - "$PWD/backend/conf:/little_hero_backend/conf"  
      - "$PWD/backend/runtimes:/little_hero_backend/runtimes"  
networks:  
  web:  
    external: true
```


## ä¿®æ”¹æœåŠ¡

ä¿®æ”¹ `docker-compose.yaml` çš„ labels åï¼Œéœ€è¦åˆ é™¤ container å¹¶é‡æ–°åˆ›å»ºï¼Œrestart åªæ˜¯é‡å¯åŸæ¥çš„ containerï¼Œä¸ä¼šåº”ç”¨ä¿®æ”¹çš„å˜åŒ–

```shell
# é”™è¯¯
docker-compose restart chat
# æ­£ç¡®
docker-compose up -d --build chat
# æ­£ç¡®
docker-compose stop chat
docker-compose rm chat
docker-compose create chat
docker-compose start chat
```


## æœåŠ¡çŠ¶æ€

### éªŒè¯

æœåŠ¡å¯åŠ¨åï¼Œé€šè¿‡ **è®¿é—®åŸŸå** å’Œ **æŸ¥çœ‹æ—¥å¿—** éªŒè¯æœåŠ¡æ˜¯å¦æ­£å¸¸å¯åŠ¨

1. æŸ¥çœ‹æœåŠ¡è¾“å‡ºæ—¥å¿—
2. å°è¯•è®¿é—®æœåŠ¡åŸŸåï¼Œ200 å³ä¸ºæ­£å¸¸
3. éªŒè¯ http èƒ½å¦è·³è½¬ https

### æ£€æŸ¥

æœåŠ¡æœªæ­£å¸¸å¯åŠ¨ æˆ– æ— æ³•è®¿é—® ä¼šæŠ¥ 404

1. æ£€æŸ¥æœåŠ¡æ˜¯å¦æˆåŠŸå¯åŠ¨
2. æ£€æŸ¥ docker-compose ä¸­ service å’Œ rule æ˜¯å¦é…ç½®æ­£ç¡®
3. é€šè¿‡æŸ¥çœ‹ traefik æ—¥å¿—è¾…åŠ©æ’æŸ¥