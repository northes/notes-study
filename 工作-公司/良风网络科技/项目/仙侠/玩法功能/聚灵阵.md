核心玩法：

https://www.kdocs.cn/l/ckNlEAypWlDY

1.  从创角开始计时，可以累积最多x秒（由 `默认可累积时长上限` 和 `额外时长上限` 决定）
2.  玩家可以在任意时间结算累积的时间，用于兑换一些奖励（类似离线结算机制，但不完全相同），所能领取的奖励受玩家当前进度决定。（经验、金币、道具）
3.  基于目前的时间道具掉落系统的设计模式另外实现。
4.  联动活动时，结算规则如下：
    1.  `当前时间`-`上次领奖时间`作为结算时长，也就是玩家可以主动攒一些时间，以便在活动开始时立即获得一波活动道具。

Issue：

https://gitlab.shouyouqianxian.com/xia/game_server/-/issues/72

---

## 累积时长

1. 满足最低开启条件后才开始计算时间。
2. 通过全局表配置项 `force_collector_base_seconds` 表示 `默认状态下玩家最多可累积的时间上限`。
3. Attr `聚灵阵额外时长上限` 描述玩家可以额外获得的累积时长上限。
4. 玩家达到 `允许累积的最大时长` 后，如未结算则不会再继续累积。

## 结算规则

1. 玩家只能手动结算，并且所能兑换的奖励只受点击结算时的主线任务进度影响。
2. 任务进度推进前的奖励不会自动结算。
3. 配表中当前主线任务进度未配置奖励的，将向前寻找直至找到可用的进度奖励：
	1. 如：配表中只配了 10,12,18 的主线任务进度奖励，当玩家处于进度 15 中时，将向前寻找使用进度 12 的任务进度奖励进行结算。
4. 当玩家点击结算的时间间隔过短，不足以产生任何一个奖励时，结算响应结果将为空。

## 计算公式

1. 产出单个奖励所需的时间计算公式为：`单日总秒数(86400)` / `单日共会产出的奖励数量`
2. 允许累积的最大时长的计算公式为： `默认状态下玩家最多可累积的时间上限` + `聚灵阵额外时长上限`
3. 产出数量的计算公式为：`当前时间` - `上次结算时间` / `产出单个奖励所需的时间`
	1. 如果 `当前时间` - `上次结算时间` 超出 `允许累积的最大时长` ，则使用 `允许累积的最大时长` 作为计算产出的依据。并校准玩家结算的时间戳。

## 校准

1. 当玩家的 `上次结算时间` 为空时，将会被校准为 `当前时间`
2. 当玩家的 `上次结算时间` 在 `当前时间` 之后时，将被校准为 `当前时间`


---

# 接口交互

## 获取聚灵阵状态

可用于获取聚灵阵当前状态，用于同步服务器状态与做表现效果

请求

```go
type ForceCollectorGetInfoRequest struct { // MessageID: 5101  
}
```

响应

```go
type ForceCollectorGetInfoResponse struct { // MessageID: 5102  
   OK   bool  
   Info *ForceCollectorInfo  
}
```

## 结算聚灵阵奖励

玩家点击兑换时，结算奖励给玩家

结算成功后，根据响应结果刷新聚灵阵状态

请求

```go
// 结算聚灵盘奖励  
type ForceCollectorGetRewardRequest struct { // MessageID: 5103  
}
```

响应

```go
type ForceCollectorGetRewardResponse struct { // MessageID: 5104  
   // 领奖成功返回true，失败返回false  
   OK bool  
   // 无论成功或者失败，总是刷新最新的聚灵盘状态  
   Info *ForceCollectorInfo  
   // 结算消耗的理论时间（看是否需要做表现）  
   SecondsSettled int64  
  
   Rewards []map[enum.CommonRewardTypeID]*enum.CommonRewardUnit  
}
```

## 通用结构

聚灵阵状态

```go
type ForceCollectorInfo struct {  
   // 计算SecondsPassed使用的服务器时间  
   // 用于客户端校对  
   TimeNowUnix int64  
   // 根据当前时间先预计可以结算的时长（用于客户端做初始表现）  
   SecondsSettled int64  
   // 玩家当前最多可累积的时长  
   // 可能存在月卡过期等场景导致 SecondsSettled > SecondsMax  
   SecondsMax int64  
}
```